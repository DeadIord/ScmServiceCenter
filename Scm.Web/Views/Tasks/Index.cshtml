@using Microsoft.AspNetCore.Mvc.Localization
@using Scm.Domain.Entities
@using Scm.Web.Models.Tasks
@model TasksIndexViewModel
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Title"].Value;
    var tasks = Model.Tasks;
    var totalTasks = Model.TotalTasks;
    var completedTasks = Model.CompletedTasks;
    var inProgressTasks = Model.InProgressTasks;
    var pendingTasks = Model.PendingTasks;

    string GetPriorityClass(OrderPriority priority) => priority switch
    {
        OrderPriority.High or OrderPriority.Critical => "high",
        OrderPriority.Low => "low",
        _ => "medium"
    };

    string GetStatusClass(TechnicianTaskStatus status) => status switch
    {
        TechnicianTaskStatus.Completed => "completed",
        TechnicianTaskStatus.InProgress => "in-progress",
        TechnicianTaskStatus.Cancelled => "cancelled",
        _ => "pending"
    };

    string GetStatusLabel(TechnicianTaskStatus status) => status switch
    {
        TechnicianTaskStatus.Completed => "Завершена",
        TechnicianTaskStatus.InProgress => "В работе",
        TechnicianTaskStatus.Cancelled => "Отменена",
        _ => "Ожидает"
    };
}
<link rel="stylesheet" href="~/css/tasks/tasks_index.css" asp-append-version="true" />
<div class="main-body">
    <div class="tasks-container">
        <div class="tasks-header">
            <div class="header-title-section">
                <div class="header-icon">
                    <i class="bi bi-list-task"></i>
                </div>
                <div class="header-text">
                    <h1>@Localizer["Heading"]</h1>
                    <p>@Localizer["Description"]</p>
                </div>
            </div>
            <div class="header-actions">
                <a asp-controller="Orders" asp-action="Create" class="btn btn-primary">
                    <i class="bi bi-plus-lg"></i>
                    @Localizer["PrimaryAction"]
                </a>
                <a asp-controller="Tasks" asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise"></i>
                    Обновить
                </a>
            </div>
        </div>
        <div class="stats-row">
            <div class="stats-card">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <p class="stats-label">Всего задач</p>
                        <div class="stats-value">@totalTasks</div>
                        <span class="stats-change neutral">100%</span>
                    </div>
                    <div class="stats-icon" style="background: #ede9fe;">
                        <i class="bi bi-list-check" style="color: #8b5cf6;"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <p class="stats-label">В работе</p>
                        <div class="stats-value">@inProgressTasks</div>
                        <span class="stats-change positive">@(totalTasks > 0 ? Math.Round((decimal)inProgressTasks / totalTasks * 100, 0) : 0)%</span>
                    </div>
                    <div class="stats-icon" style="background: #dbeafe;">
                        <i class="bi bi-hourglass-split" style="color: #2563eb;"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <p class="stats-label">Завершено</p>
                        <div class="stats-value">@completedTasks</div>
                        <span class="stats-change positive">@(totalTasks > 0 ? Math.Round((decimal)completedTasks / totalTasks * 100, 0) : 0)%</span>
                    </div>
                    <div class="stats-icon" style="background: #d1fae5;">
                        <i class="bi bi-check-circle" style="color: #059669;"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <p class="stats-label">Ожидают</p>
                        <div class="stats-value">@pendingTasks</div>
                        <span class="stats-change negative">Требует внимания</span>
                    </div>
                    <div class="stats-icon" style="background: #fff3cd;">
                        <i class="bi bi-clock-history" style="color: #ffd321;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="filter-card">
            <h2 class="filter-title">
                <i class="bi bi-funnel"></i>
                Фильтры и поиск
            </h2>
            <form class="filter-form" method="get">
                <div class="filter-group">
                    <label class="filter-label">Поиск</label>
                    <input class="form-control" type="search" name="in_q" value="@Model.Query" placeholder="Номер заказа или описание" />
                </div>
                <div class="filter-group">
                    <label class="filter-label">Статус</label>
                    <select class="form-select" name="in_status">
                        <option value="">Все статусы</option>
                        <option value="Pending" selected="@(Model.Status == TechnicianTaskStatus.Pending ? "selected" : null)">Ожидает</option>
                        <option value="InProgress" selected="@(Model.Status == TechnicianTaskStatus.InProgress ? "selected" : null)">В работе</option>
                        <option value="Completed" selected="@(Model.Status == TechnicianTaskStatus.Completed ? "selected" : null)">Завершено</option>
                        <option value="Cancelled" selected="@(Model.Status == TechnicianTaskStatus.Cancelled ? "selected" : null)">Отменено</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i>
                        Найти
                    </button>
                </div>
            </form>
        </div>
        <div class="tasks-table-card">
            @if (!tasks.Any())
            {
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-list-task"></i>
                    </div>
                    <h3 class="empty-state-title">@Localizer["EmptyTitle"]</h3>
                    <p class="empty-state-text">@Localizer["EmptyDescription"]</p>
                    <a asp-controller="Orders" asp-action="Create" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i>
                        @Localizer["PrimaryAction"]
                    </a>
                </div>
            }
            else
            {
                <div class="table-wrapper">
                    <table class="tasks-table">
                        <thead>
                            <tr>
                                <th>Задача</th>
                                <th>Приоритет</th>
                                <th>Статус</th>
                                <th>Срок</th>
                                <th>Исполнитель</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var task in tasks)
                            {
                                var priorityClass = GetPriorityClass(task.Priority);
                                var statusClass = GetStatusClass(task.Status);
                                var statusLabel = GetStatusLabel(task.Status);
                                var dueLabel = task.DueDateUtc.HasValue ? task.DueDateUtc.Value.ToLocalTime().ToString("dd.MM.yyyy") : "Не задан";
                                <tr>
                                    <td>
                                        <div class="task-name-cell">
                                            <div class="task-icon">@task.Initials</div>
                                            <div class="task-info">
                                                <div class="task-title">@task.Title</div>
                                                <div class="task-description">@task.Description</div>
                                                @if (!string.IsNullOrEmpty(task.OrderNumber))
                                                {
                                                    <div class="task-meta">Заказ: @task.OrderNumber</div>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="priority-badge @priorityClass">
                                            @if (task.Priority == OrderPriority.High || task.Priority == OrderPriority.Critical)
                                            {
                                                <i class="bi bi-arrow-up-circle"></i>
                                                <text>Высокий</text>
                                            }
                                            else if (task.Priority == OrderPriority.Low)
                                            {
                                                <i class="bi bi-arrow-down-circle"></i>
                                                <text>Низкий</text>
                                            }
                                            else
                                            {
                                                <i class="bi bi-circle"></i>
                                                <text>Средний</text>
                                            }
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge @statusClass">
                                            @statusLabel
                                        </span>
                                    </td>
                                    <td>
                                        <div class="date-cell @(task.IsOverdue ? "overdue" : string.Empty)">
                                            <i class="bi bi-calendar3"></i>
                                            <div class="date-info">
                                                <div class="date-label">@dueLabel</div>
                                                <div class="date-sub">Создана @task.CreatedAtUtc.ToLocalTime().ToString("dd.MM.yyyy")</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="assignee-cell">
                                            <div class="assignee-avatar">@task.Initials</div>
                                            <div class="assignee-info">
                                                <div class="assignee-name">@task.Assignee</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="actions-cell">
                                        <div class="btn-group">
                                            <a asp-controller="Orders" asp-action="Details" asp-route-id="@task.OrderId" asp-route-returnUrl="@Url.Action("Index", "Tasks", new { in_q = Model.Query, in_status = Model.Status })" class="btn btn-link">Подробнее</a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>
