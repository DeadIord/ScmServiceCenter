@using Microsoft.AspNetCore.Mvc.Localization
@using Scm.Domain.Entities
@model IReadOnlyCollection<Scm.Web.Models.ReportBuilder.ReportDefinitionListItemViewModel>
@inject IViewLocalizer Localizer

@section Styles {
    <link rel="stylesheet" href="~/css/reports/report_builder.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/reports/report_list.css" asp-append-version="true" />
}

@{
    ViewData["Title"] = Localizer["Title"].Value;
    var searchQuery = ViewBag.SearchQuery as string ?? string.Empty;
    ReportVisibility? selectedVisibility = ViewBag.CurrentVisibility != null ? (ReportVisibility)ViewBag.CurrentVisibility : null;
}

<div class="main-body">
    <div class="report-builder-container">
        <div class="builder-header report-list-header">
            <div>
                <p class="text-uppercase text-muted fw-semibold mb-1">@Localizer["Heading"]</p>
                <h1 class="display-6 mb-2">@Localizer["Title"]</h1>
                <p class="builder-subtitle">@Localizer["Description"]</p>
            </div>
            <div class="header-actions">
                <a class="btn btn-outline-secondary" asp-controller="Reports" asp-action="Dashboard">
                    <i class="bi bi-bar-chart"></i> @Localizer["DashboardAction"]
                </a>
                <a class="btn btn-primary" asp-action="Edit">
                    <i class="bi bi-plus-lg"></i> @Localizer["NewReportAction"]
                </a>
            </div>
        </div>

        <div class="report-card shadow-sm rounded-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2 class="h5 mb-1">@Localizer["FiltersTitle"]</h2>
                        <p class="text-muted mb-0">@Localizer["FiltersDescription"]</p>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(searchQuery) || selectedVisibility.HasValue)
                    {
                        <a asp-action="Index" class="btn btn-link text-decoration-none reset-link">@Localizer["ResetFilters"]</a>
                    }
                </div>
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["SearchLabel"]</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="search" name="search" value="@searchQuery" class="form-control" placeholder="@Localizer[\"SearchPlaceholder\"]" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">@Localizer["VisibilityFilterLabel"]</label>
                        <select class="form-select" name="visibility">
                            <option value="">@Localizer["VisibilityAll"]</option>
                            <option value="@ReportVisibility.Private" selected="@(selectedVisibility == ReportVisibility.Private ? "selected" : null)">@Localizer["VisibilityPrivate"]</option>
                            <option value="@ReportVisibility.Team" selected="@(selectedVisibility == ReportVisibility.Team ? "selected" : null)">@Localizer["VisibilityTeam"]</option>
                            <option value="@ReportVisibility.Organization" selected="@(selectedVisibility == ReportVisibility.Organization ? "selected" : null)">@Localizer["VisibilityOrganization"]</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-primary">@Localizer["ApplyFilters"]</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="report-card shadow-sm rounded-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-sticky mb-0 report-list-table">
                        <thead class="table-light">
                            <tr>
                                <th>@Localizer["NameColumn"]</th>
                                <th>@Localizer["DescriptionColumn"]</th>
                                <th>@Localizer["VisibilityColumn"]</th>
                                <th>@Localizer["CreatedColumn"]</th>
                                <th class="text-end">@Localizer["ActionsColumn"]</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if (!Model.Any())
                        {
                            <tr class="table-empty-row">
                                <td colspan="5" class="text-center py-5 table-empty">@Localizer["EmptyState"]</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var report in Model)
                            {
                                <tr>
                                    <td class="fw-semibold">
                                        <div class="d-flex align-items-start gap-2">
                                            <i class="bi bi-file-earmark-text text-primary"></i>
                                            <div>
                                                <div>@report.Title</div>
                                                <small class="text-muted">@Localizer["CreatedBy", report.CreatedAtUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")]</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">@(string.IsNullOrWhiteSpace(report.Description) ? Localizer["NoDescription"] : report.Description)</td>
                                    <td>
                                        @switch (report.Visibility)
                                        {
                                            case ReportVisibility.Private:
                                                @Localizer["VisibilityPrivate"]
                                                break;
                                            case ReportVisibility.Team:
                                                @Localizer["VisibilityTeam"]
                                                break;
                                            case ReportVisibility.Organization:
                                                @Localizer["VisibilityOrganization"]
                                                break;
                                        }
                                    </td>
                                    <td>@report.CreatedAtUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</td>
                                    <td class="text-end">
                                        <div class="d-inline-flex gap-2 action-buttons">
                                            <a class="btn btn-outline-secondary btn-sm" asp-action="Preview" asp-route-id="@report.Id">
                                                <i class="bi bi-play-circle"></i> @Localizer["PreviewAction"]
                                            </a>
                                            @if (report.CanEdit)
                                            {
                                                <a class="btn btn-primary btn-sm" asp-action="Edit" asp-route-id="@report.Id">
                                                    <i class="bi bi-pencil"></i> @Localizer["EditAction"]
                                                </a>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
