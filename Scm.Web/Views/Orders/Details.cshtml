@model Scm.Web.Models.Orders.OrderDetailsViewModel
@using Scm.Domain.Entities
@{
    ViewData["Title"] = $"Заказ {Model.Order.Number}";
    ViewData["Header"] = true;
    
    OrderStatus[] statuses = Enum.GetValues<OrderStatus>();
    OrderPriority priority = Model.Order.Priority;
    
    string StatusBadge(OrderStatus in_status) => in_status switch
    {
        OrderStatus.Received => "secondary",
        OrderStatus.Diagnosing => "info",
        OrderStatus.WaitingApproval => "warning",
        OrderStatus.InRepair => "primary",
        OrderStatus.Ready => "success",
        OrderStatus.Closed => "dark",
        _ => "secondary"
    };
    
    string StatusTitle(OrderStatus in_status) => in_status switch
    {
        OrderStatus.Received => "Принят",
        OrderStatus.Diagnosing => "Диагностика",
        OrderStatus.WaitingApproval => "Ожидает согласования",
        OrderStatus.InRepair => "В ремонте",
        OrderStatus.Ready => "Готов",
        OrderStatus.Closed => "Закрыт",
        _ => in_status.ToString()
    };
    
    string PriorityBadge(OrderPriority in_priority) => in_priority switch
    {
        OrderPriority.Low => "secondary",
        OrderPriority.Normal => "light text-dark",
        OrderPriority.High => "warning",
        OrderPriority.Critical => "danger",
        _ => "secondary"
    };
    
    string PriorityTitle(OrderPriority in_priority) => in_priority switch
    {
        OrderPriority.Low => "Низкий",
        OrderPriority.Normal => "Нормальный",
        OrderPriority.High => "Высокий",
        OrderPriority.Critical => "Критичный",
        _ => in_priority.ToString()
    };
    
    // Функция для получения инициалов
    string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
    }

    string GetAssignedUserName()
    {
        string ret;
        if (Model.Order.AssignedUser is null)
        {
            ret = string.Empty;
        }
        else if (!string.IsNullOrWhiteSpace(Model.Order.AssignedUser.DisplayName))
        {
            ret = Model.Order.AssignedUser.DisplayName;
        }
        else if (!string.IsNullOrWhiteSpace(Model.Order.AssignedUser.UserName))
        {
            ret = Model.Order.AssignedUser.UserName;
        }
        else
        {
            ret = Model.Order.AssignedUser.Email ?? string.Empty;
        }

        return string.IsNullOrWhiteSpace(ret) ? "Не назначен" : ret;
    }
    
    // Определяем текущий индекс статуса для прогресс-бара
    int GetStatusIndex(OrderStatus status) => status switch
    {
        OrderStatus.Received => 0,
        OrderStatus.Diagnosing => 1,
        OrderStatus.WaitingApproval => 2,
        OrderStatus.InRepair => 3,
        OrderStatus.Ready => 4,
        OrderStatus.Closed => 5,
        _ => 0
    };
    
    int currentStatusIndex = GetStatusIndex(Model.Order.Status);
}

<link rel="stylesheet" href="~/css/orders/orders_details.css" asp-append-version="true" />

<div class="main-body" data-order-id="@Model.Order.Id">
    <div class="order-details-modern">
        <!-- Header -->
        <div class="order-header mb-4 justify-content-start gap-3">
            <div class="d-flex align-items-center gap-3">
                <a href="@(string.IsNullOrWhiteSpace(Model.ReturnUrl) ? Url.Action("Index") : Model.ReturnUrl)" class="btn btn-icon">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h1 class="order-header-title mb-1">Заказ #@Model.Order.Number</h1>
                    <p class="order-header-subtitle mb-0">@Model.Order.CreatedAtUtc.ToLocalTime().ToString("MMM dd, yyyy, HH:mm") (ET)</p>
                </div>
            </div>
            <div class="d-flex gap-3 flex-wrap">
                <span class="status-badge status-@StatusBadge(Model.Order.Status)">
                    <span class="status-dot"></span>
                    @StatusTitle(Model.Order.Status)
                </span>
                <span class="priority-badge priority-@PriorityBadge(priority).Split(' ')[0]">
                    @PriorityTitle(priority)
                </span>
            </div>
        </div>

        <div class="row g-4">
            <div class="row g-4">
                <!-- Левая колонка -->
                <div class="col-lg-8">
                    <!-- Прогресс заказа -->
                    <div class="card-modern mb-4">
                        <div class="card-header-modern flex-wrap">
                            <h5 class="card-title-modern">
                                <i class="bi bi-clock-history me-2"></i>Статус заказа
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <label for="status-select" class="form-label mb-0 text-muted small">Выберите статус</label>
                                <select class="form-select form-select-sm" id="status-select">
                                    @foreach (var status in statuses)
                                    {
                                        <option value="@status" selected="@(status == Model.Order.Status ? "selected" : null)">@StatusTitle(status)</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="card-body-modern">
                            @await Html.PartialAsync("_OrderProgress", (Model.Order, currentStatusIndex))
                        </div>
                    </div>

                <!-- Детали заказа -->
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <h5 class="card-title-modern">
                            <i class="bi bi-list-check me-2"></i>Детали заказа
                        </h5>
                    </div>
                    <div class="card-body-modern">
                        @await Html.PartialAsync("_QuoteTable", Model.Order)
                        

                        
                        <div class="mt-4">
                            <button class="btn btn-primary" id="submit-quote" data-order-id="@Model.Order.Id">
                                <i class="bi bi-send me-2"></i>Отправить на согласование
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Правая колонка -->
            <div class="col-lg-4">
                <div class="">
                    <!-- Информация о клиенте -->
                    <div class="card-modern mb-4">
                        <div class="card-header-modern">
                            <h5 class="card-title-modern">
                                <i class="bi bi-person me-2"></i>Клиент
                            </h5>                      
                        </div>
                        <div class="card-body-modern">
                            <div class="customer-info">
                                <div class="customer-avatar-large bg-primary">
                                    @GetInitials(Model.Order.ClientName)
                                </div>
                                <div class="customer-details">
                                    <h6 class="customer-name-large">@Model.Order.ClientName</h6>
                                    <p class="customer-id">ID клиента: #@Model.Order.Id.ToString().Substring(0, 6)</p>
                                </div>
                            </div>
                       
                            
                            <hr class="my-3">
                            
                            <div class="contact-info-section">
                                <h6 class="contact-info-title">
                                    Контактная информация
                                </h6>
                                
                                @if (!string.IsNullOrWhiteSpace(Model.Order.ClientEmail))
                                {
                                    <div class="contact-item">
                                        <i class="bi bi-envelope"></i>
                                        <div>
                                            <div class="contact-label">Email:</div>
                                            <a href="mailto:@Model.Order.ClientEmail" class="contact-value">@Model.Order.ClientEmail</a>
                                        </div>
                                    </div>
                                }
                                
                                <div class="contact-item">
                                    <i class="bi bi-telephone"></i>
                                    <div>
                                        <div class="contact-label">Телефон:</div>
                                        <a href="tel:@Model.Order.ClientPhone" class="contact-value">@Model.Order.ClientPhone</a>
                                    </div>
                                </div>
                                <div class="contact-item">
                                    <i class="bi bi-person-gear"></i>
                                    <div>
                                        <div class="contact-label">Исполнитель:</div>
                                        <div class="contact-value">@GetAssignedUserName()</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- Устройство -->
                    <div class="card-modern mb-4">
                        <div class="card-header-modern">
                            <h5 class="card-title-modern">
                                <i class="bi bi-phone me-2"></i>Устройство
                            </h5>
                        </div>
                        <div class="card-body-modern">
                            <div class="device-info">
                                <div class="device-icon">
                                    <i class="bi bi-phone"></i>
                                </div>
                                <div>
                                    <div class="device-name">@Model.Order.Device</div>
                                    @if (!string.IsNullOrWhiteSpace(Model.Order.Serial))
                                    {
                                        <div class="device-serial">S/N: @Model.Order.Serial</div>
                                    }
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <!-- Действия -->
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <h5 class="card-title-modern">
                            <i class="bi bi-lightning me-2"></i>Действия
                        </h5>
                    </div>
                    <div class="card-body-modern">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" id="action-submit-quote" data-order-id="@Model.Order.Id">
                                <i class="bi bi-send-check me-2"></i>Отправить смету
                            </button>
                            <a class="btn btn-outline-success" href="#" id="action-generate-invoice" data-order-id="@Model.Order.Id">
                                <i class="bi bi-receipt me-2"></i>Сформировать счёт
                            </a>
                        </div>
                        
                        <hr class="my-3">
                        
                        <div class="client-access-info">
                            <div class="info-label mb-2">
                                <i class="bi bi-link-45deg me-1"></i>Ссылка для клиента:
                            </div>
                            <div class="input-group input-group-sm">
                                <input class="form-control" value="@Model.ClientTrackingLink" readonly id="clientLink" />
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Сообщения -->
                <div class="card-modern">
                    <div class="card-header-modern">
                        <h5 class="card-title-modern">
                            <i class="bi bi-chat-dots me-2"></i>Переписка с клиентом
                        </h5>
                    </div>
                    <div class="card-body-modern">
                        <div class="messages-container" id="messages-container">
                            @foreach (var message in Model.Messages)
                            {
                                var alignment = message.FromClient ? "start" : "end";
                                var bubbleClass = message.FromClient ? "message-bubble-client" : "message-bubble-staff";
                                <div class="message-wrapper message-@alignment">
                                    <div class="message-bubble @bubbleClass">
                                        <div class="message-header">
                                            <span class="message-author">@(message.FromClient ? "Клиент" : "Сотрудник")</span>
                                            <span class="message-time">@message.AtUtc.ToLocalTime().ToString("MMM dd, HH:mm")</span>
                                        </div>
                                        <div class="message-text">@message.Text</div>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <form id="message-form" class="message-form mt-4">
                            <input type="hidden" name="OrderId" value="@Model.Order.Id" />
                            <div class="message-input-group">
                                <textarea class="form-control message-input" name="Text" rows="2" 
                                        placeholder="Написать сообщение..." required></textarea>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/orders/orders_details.js" asp-append-version="true"></script>
}
