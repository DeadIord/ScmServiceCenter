@model Scm.Web.Models.Orders.OrdersIndexViewModel
@using Scm.Domain.Entities
@{
    ViewData["Title"] = "Заказы";
    OrderStatus[] statuses = Enum.GetValues<OrderStatus>();
    
    string StatusBadge(OrderStatus in_status) => in_status switch
    {
        OrderStatus.Received => "secondary",
        OrderStatus.Diagnosing => "info",
        OrderStatus.WaitingApproval => "warning",
        OrderStatus.InRepair => "primary",
        OrderStatus.Ready => "success",
        OrderStatus.Closed => "dark",
        _ => "secondary"
    };
    
    string StatusTitle(OrderStatus in_status) => in_status switch
    {
        OrderStatus.Received => "Принят",
        OrderStatus.Diagnosing => "Диагностика",
        OrderStatus.WaitingApproval => "Cогласование",
        OrderStatus.InRepair => "В ремонте",
        OrderStatus.Ready => "Готов",
        OrderStatus.Closed => "Закрыт",
        _ => in_status.ToString()
    };
    
    string PriorityBadge(OrderPriority in_priority) => in_priority switch
    {
        OrderPriority.Low => "secondary",
        OrderPriority.Normal => "light text-dark",
        OrderPriority.High => "warning",
        OrderPriority.Critical => "danger",
        _ => "secondary"
    };
    
    string PriorityTitle(OrderPriority in_priority) => in_priority switch
    {
        OrderPriority.Low => "Низкий",
        OrderPriority.Normal => "Нормальный",
        OrderPriority.High => "Высокий",
        OrderPriority.Critical => "Критичный",
        _ => in_priority.ToString()
    };
    
    string SlaClass(DateTime? in_date) => in_date is null ? "text-muted" : 
        in_date.Value < DateTime.UtcNow ? "text-danger fw-semibold" : "text-success";
    
    
    // Функция для получения инициалов
    string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
    }
    
    // Цвета для аватаров
    string[] avatarColors = { "primary", "success", "info", "warning", "danger", "secondary" };
    string GetAvatarColor(int index) => avatarColors[index % avatarColors.Length];
}

<link rel="stylesheet" href="~/css/orders/orders_index.css" asp-append-version="true" />

<div class="main-body">

    <div class="orders-modern-container">
        <!-- Статистика сверху -->
        <div class="stats-grid mb-4">
            <div class="stat-card">
                <div class="stat-icon bg-warning-subtle">
                    <i class="bi bi-clock-history text-warning"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Orders.Count(o => o.Status == OrderStatus.Received)</div>
                    <div class="stat-label">Принято</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-primary-subtle">
                    <i class="bi bi-gear text-primary"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Orders.Count(o => o.Status == OrderStatus.InRepair || o.Status == OrderStatus.Diagnosing)</div>
                    <div class="stat-label">В работе</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-success-subtle">
                    <i class="bi bi-check-circle text-success"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Orders.Count(o => o.Status == OrderStatus.Ready)</div>
                    <div class="stat-label">Готово</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-danger-subtle">
                    <i class="bi bi-exclamation-triangle text-danger"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Orders.Count(o => o.SLAUntil.HasValue && o.SLAUntil.Value < DateTime.UtcNow)</div>
                    <div class="stat-label">Просрочено</div>
                </div>
            </div>
        </div>

        <!-- Header с кнопками -->
        <div class="orders-header mb-4">
            <div>
                <h1 class="orders-title mb-1">Очередь заказов</h1>
                <p class="orders-subtitle mb-0">Актуальные ремонты, статусы согласования и связь с клиентами</p>
            </div>
            <div class="orders-actions">
                <a class="btn btn-primary" asp-action="Create">
                    <i class="bi bi-plus-circle me-2"></i>Создать заказ
                </a>
            </div>
        </div>

        <!-- Фильтры -->
        <div class="filters-card">
            <form method="get" class="filters-form">
                <div class="search-wrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="form-control search-input" name="q" 
                        value="@Model.Query" placeholder="Поиск по номеру, клиенту, email или устройству" />
                </div>
                
                <div class="quick-filters">
                    <label class="filter-label">Быстрые фильтры:</label>
                    <div class="filter-badges">
                        <a class="filter-badge @(Model.Status == null ? "active" : "")" 
                        href="@Url.Action("Index", new { status = (OrderStatus?)null, q = Model.Query })">
                            Все
                        </a>
                        @foreach (var status in statuses)
                        {
                            bool selected = Model.Status == status;
                            <a class="filter-badge filter-badge-@StatusBadge(status) @(selected ? "active" : "")" 
                            href="@Url.Action("Index", new { status = selected ? (OrderStatus?)null : status, q = Model.Query })">
                                @StatusTitle(status)
                            </a>
                        }
                    </div>
                </div>
            </form>
        </div>

        <!-- Таблица -->
        <div class="orders-table-card">
            <div class="table-responsive">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th class="text-center">№</th>
                            <th>ЗАКАЗ</th>
                            <th>КЛИЕНТ</th>
                            <th>УСТРОЙСТВО</th>
                            <th>СТАТУС</th>
                            <th>ПРИОРИТЕТ</th>
                            <th>ДАТА СОЗДАНИЯ</th>
                            <th>SLA</th>
                            <th>ДЕЙСТВИЕ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.Orders.Any())
                        {
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="bi bi-inbox display-4 d-block mb-3 text-muted"></i>
                                    <p class="mb-0">Заказы не найдены</p>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @for (int i = 0; i < Model.Orders.Count(); i++)
                            {
                                var order = Model.Orders.ElementAt(i);
                                <tr class="order-row">
                                    <td class="text-center">
                                        <span class="row-number"></span>
                                    </td>
                                    <td>
                                        <span class="order-number">@order.Number</span>
                                    </td>
                                    <td>
                                        <div class="customer-cell">
                                            <div class="customer-avatar bg-@GetAvatarColor(i)">
                                                @GetInitials(order.ClientName)
                                            </div>
                                            <div class="customer-info">
                                                <div class="customer-name">@order.ClientName</div>
                                                @if (!string.IsNullOrWhiteSpace(order.ClientEmail))
                                                {
                                                    <div class="customer-email">@order.ClientEmail</div>
                                                }
                                                else
                                                {
                                                    <div class="customer-email">@order.ClientPhone</div>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="device-name">@order.Device</div>
                                    </td>
                                    <td>
                                        <span class="status-badge status-@StatusBadge(order.Status)">
                                            @StatusTitle(order.Status)
                                        </span>
                                    </td>
                                    <td>
                                        <span class="priority-badge priority-@PriorityBadge(order.Priority).Split(' ')[0]">
                                            @PriorityTitle(order.Priority)
                                        </span>
                                    </td>
                                    <td>
                                        <div class="order-date">@order.CreatedAtUtc.ToLocalTime().ToString("dd.MM.yyyy, HH:mm")</div>
                                    </td>
                                    <td>
                                        <div class="sla-cell @SlaClass(order.SLAUntil)">
                                            @if (order.SLAUntil.HasValue)
                                            {
                                                if (order.SLAUntil.Value < DateTime.UtcNow)
                                                {
                                                    @* <i class="bi bi-exclamation-circle me-1"></i> *@
                                                }
                                                @order.SLAUntil.Value.ToString("dd.MM.yyyy")
                                            }
                                            else
                                            {
                                                <span>—</span>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <div class="dropdown">
                                                <button class="btn-action" type="button" data-bs-toggle="dropdown">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li><a class="dropdown-item" asp-action="Details" asp-route-id="@order.Id">
                                                        <i class="bi bi-eye me-2"></i>Просмотр
                                                    </a></li>

                                                    <li><hr class="dropdown-divider"></hr></li>
                                                    <li><a class="dropdown-item text-danger" href="#">
                                                        <i class="bi bi-trash me-2"></i>Удалить
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
            <div class="table-pagination"></div>
            <div class="pagination-count"></div>
        </div>
    <!-- Мобильный вид (карточки) -->
        <div class="mobile-orders-grid">
            @if (!Model.Orders.Any())
            {
                <div class="empty-state" style="text-align: center; padding: 4rem 1rem;">
                    <i class="bi bi-inbox display-4 d-block mb-3 text-muted"></i>
                    <p class="mb-0">Заказы не найдены</p>
                </div>
            }
            else
            {
                @for (int i = 0; i < Model.Orders.Count(); i++)
                {
                    var order = Model.Orders.ElementAt(i);
                    var statusClass = order.Status switch
                    {
                        OrderStatus.Received => "status-received",
                        OrderStatus.Diagnosing => "status-diagnosing",
                        OrderStatus.WaitingApproval => "status-waiting",
                        OrderStatus.InRepair => "status-repair",
                        OrderStatus.Ready => "status-ready",
                        OrderStatus.Closed => "status-closed",
                        _ => "status-received"
                    };
                    
                    <div class="mobile-order-card @statusClass">
                        <!-- Заголовок -->
                        <div class="mobile-order-header">
                            <span class="mobile-order-number">@order.Number</span>
                            <span class="status-badge status-@StatusBadge(order.Status)">
                                @StatusTitle(order.Status)
                            </span>
                        </div>
                        
                        <!-- Тело карточки -->
                        <div class="mobile-order-body">
                            <!-- Клиент -->
                            <div class="mobile-info-row">
                                <div class="mobile-info-icon">
                                    <i class="bi bi-person"></i>
                                </div>
                                <div class="mobile-info-content">
                                    <div class="mobile-info-label">Клиент</div>
                                    <div class="mobile-info-value">@order.ClientName</div>
                                    @if (!string.IsNullOrWhiteSpace(order.ClientEmail))
                                    {
                                        <div class="mobile-info-value small">@order.ClientEmail</div>
                                    }
                                    <div class="mobile-info-value small">@order.ClientPhone</div>
                                </div>
                            </div>
                            
                            <!-- Устройство -->
                            <div class="mobile-info-row">
                                <div class="mobile-info-icon">
                                    <i class="bi bi-gear"></i>
                                </div>
                                <div class="mobile-info-content">
                                    <div class="mobile-info-label">Устройство</div>
                                    <div class="mobile-info-value">@order.Device</div>
                                </div>
                            </div>
                            
                            <!-- Приоритет и SLA -->
                            <div class="mobile-info-row">
                                <div class="mobile-info-icon">
                                    <i class="bi bi-flag"></i>
                                </div>
                                <div class="mobile-info-content">
                                    <div class="mobile-info-label">Приоритет и SLA</div>
                                    <div class="mobile-badges">
                                        <span class="priority-badge priority-@PriorityBadge(order.Priority).Split(' ')[0]">
                                            @PriorityTitle(order.Priority)
                                        </span>
                                        @if (order.SLAUntil.HasValue)
                                        {
                                            <span class="badge @(order.SLAUntil.Value < DateTime.UtcNow ? "bg-danger" : "bg-success")">
                                                SLA: @order.SLAUntil.Value.ToString("dd.MM.yyyy")
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Футер -->
                        <div class="mobile-order-footer">
                            <div class="mobile-order-date">
                                <i class="bi bi-clock me-1"></i>
                                @order.CreatedAtUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
                            </div>
                            <div class="mobile-order-actions">
                                <a href="@Url.Action("Details", new { id = order.Id })" class="mobile-btn mobile-btn-primary">
                                    <i class="bi bi-eye"></i>
                                    Открыть
                                </a>
                            </div>
                        </div>
                        <span class="row-number" style="display: none;">@(i + 1)</span>
                    </div>
                }
            }
            <div class="mobile-pagination"></div>
            <div class="pagination-count"></div>
        </div>
    </div>
    @if (Model.TotalCount > 0)
    {
        <div class="card-footer py-3">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <span class="text-muted small">@string.Format(Localizer["PaginationSummary"].Value, Model.StartRecord, Model.EndRecord, Model.TotalCount)</span>
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="@Localizer["PaginationLabel"]">
                        <ul class="pagination pagination-rounded justify-content-center mb-0">
                            <li class="page-item @(Model.HasPrevious ? string.Empty : "disabled")">
                                <a class="page-link" href="@(Model.HasPrevious ? BuildPageUrl(Model.PageNumber - 1) : "#")" aria-label="@Localizer["PaginationPrevious"]" @(Model.HasPrevious ? string.Empty : "aria-disabled=\"true\"")>
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            @for (int pageNumber = startPage; pageNumber <= endPage; pageNumber++)
                            {
                                bool isActive = pageNumber == Model.PageNumber;
                                <li class="page-item @(isActive ? "active" : string.Empty)">
                                    <a class="page-link" href="@(isActive ? "#" : BuildPageUrl(pageNumber))" @(isActive ? "aria-current=\"page\"" : string.Empty)>@pageNumber</a>
                                </li>
                            }
                            <li class="page-item @(Model.HasNext ? string.Empty : "disabled")">
                                <a class="page-link" href="@(Model.HasNext ? BuildPageUrl(Model.PageNumber + 1) : "#")" aria-label="@Localizer["PaginationNext"]" @(Model.HasNext ? string.Empty : "aria-disabled=\"true\"")>
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            </div>
        </div>
    }
</div>

<div class="modal fade" id="ticketComposeModal" tabindex="-1" aria-labelledby="ticketComposeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5" id="ticketComposeModalLabel">@Localizer["ComposeModalTitle"]</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Localizer["ComposeClose"]"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">@Localizer["ComposeModalDescription"]</p>
                <div class="alert d-none" data-compose-feedback></div>
                <form id="ticket-compose-form" asp-controller="Tickets" asp-action="Compose" method="post" enctype="multipart/form-data" novalidate>
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="compose-email" class="form-label">@Localizer["ComposeEmailLabel"]</label>
                        <input type="email" class="form-control" id="compose-email" name="Email" required readonly />
                    </div>
                    <div class="mb-3">
                        <label for="compose-client-name" class="form-label">@Localizer["ComposeClientNameLabel"]</label>
                        <input type="text" class="form-control" id="compose-client-name" name="ClientName" />
                    </div>
                    <div class="mb-3">
                        <label for="compose-subject" class="form-label">@Localizer["ComposeSubjectLabel"]</label>
                        <input type="text" class="form-control" id="compose-subject" name="Subject" required />
                    </div>
                    <div class="mb-3">
                        <label for="compose-body" class="form-label">@Localizer["ComposeBodyLabel"]</label>
                        <textarea class="form-control" id="compose-body" name="Body" rows="6" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="compose-attachments" class="form-label">@Localizer["ComposeAttachmentsLabel"]</label>
                        <input class="form-control" id="compose-attachments" name="Attachments" type="file" multiple />
                        <div class="form-text">@Localizer["ComposeAttachmentsHint"]</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">@Localizer["ComposeCancel"]</button>
                <button type="submit" class="btn btn-primary" form="ticket-compose-form">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                    <span>@Localizer["ComposeSubmit"]</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/orders/orders_index.js" asp-append-version="true"></script>
}