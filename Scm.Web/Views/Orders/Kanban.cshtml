@model Scm.Web.Models.Orders.OrderKanbanViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@using Scm.Domain.Entities
@using System.Linq
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Title"];
    string StatusBadge(OrderStatus in_status) => in_status switch
    {
        OrderStatus.Received => "secondary",
        OrderStatus.Diagnosing => "info",
        OrderStatus.WaitingApproval => "warning",
        OrderStatus.InRepair => "primary",
        OrderStatus.Ready => "success",
        OrderStatus.Closed => "dark",
        _ => "secondary"
    };
    string PriorityBadge(OrderPriority in_priority) => in_priority switch
    {
        OrderPriority.Low => "secondary",
        OrderPriority.Normal => "light text-dark",
        OrderPriority.High => "warning",
        OrderPriority.Critical => "danger",
        _ => "secondary"
    };
    string PriorityTitle(OrderPriority in_priority)
    {
        string ret = Localizer[$"Priority_{in_priority}"];
        return ret;
    }
}
<h1 class="section-title mb-4">@Localizer["SectionTitle"]</h1>
<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 row-cols-xxl-6 g-4" id="kanban-board">
    @foreach (var column in Model.Columns)
    {
        <div class="col">
            <div class="card shadow-sm rounded-3 h-100 kanban-status-card">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">@Localizer[$"Status_{column.Status}"]</span>
                    <span class="badge text-bg-@StatusBadge(column.Status) js-column-count">@column.Orders.Count</span>
                </div>
                <div class="card-body py-3 kanban-column" data-status="@column.Status" id="col-@column.Status">
                    @foreach (var order in column.Orders.OrderBy(o => o.CreatedAtUtc))
                    {
                        var slaClass = order.SLAUntil.HasValue && order.SLAUntil < DateTime.UtcNow ? "text-bg-danger" : "text-bg-success";
                        <div class="card shadow-sm rounded-3 mb-3 kanban-item" data-id="@order.Id">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-semibold">@order.Number</span>
                                    <span class="badge text-bg-@PriorityBadge(order.Priority)">@PriorityTitle(order.Priority)</span>
                                </div>
                                <div class="small text-muted">@order.Device</div>
                                <div class="small">@order.ClientName</div>
                                <div class="mt-2">
                                    <span class="badge @slaClass">@Localizer["SlaShortLabel"]: @(order.SLAUntil?.ToString("dd.MM") ?? Localizer["NoValuePlaceholder"].Value)</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" integrity="sha384-8ZrYuoBByxGr2susx1bwyodHtnV1OYpvyRq67Vi/+R0DSf8PS3gsZ0Ljzm+hY9+S" crossorigin="anonymous"></script>
    <script>
        if (typeof initKanbanBoard === 'function') {
            initKanbanBoard();
        }
    </script>
}
