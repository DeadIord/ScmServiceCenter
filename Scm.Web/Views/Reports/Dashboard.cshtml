@model Scm.Web.Models.Reports.DashboardViewModel
@using System.Text.Json
@{ 
    ViewData["Title"] = "Дашборд"; 
    var periodStartValue = Model.PeriodStart?.ToString("yyyy-MM-dd") ?? string.Empty; 
    var periodEndValue = Model.PeriodEnd?.ToString("yyyy-MM-dd") ?? string.Empty; 
    var currencyValue = Model.Currency;
    var jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }; 
    var ordersChartJson = JsonSerializer.Serialize(Model.OrdersByDay, jsonOptions); 
    var revenueChartJson = JsonSerializer.Serialize(Model.RevenueByWeek, jsonOptions); 
} 

<link rel="stylesheet" href="~/css/reports/dashboard.css" asp-append-version="true" />

<div class="dashboard-container">
    <!-- Заголовок -->
    <div class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Дашборд</h1>
            <p class="dashboard-subtitle">Ключевые показатели и аналитика</p>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="filter-card">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-semibold mb-2">Начало периода</label>
                <input type="date" class="form-control date-input" name="periodStart" value="@periodStartValue" />
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold mb-2">Окончание периода</label>
                <input type="date" class="form-control date-input" name="periodEnd" value="@periodEndValue" />
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold mb-2">Валюта</label>
                <select class="form-select" name="currency">
                    @foreach (var code in Model.AvailableCurrencies)
                    {
                        <option value="@code" selected="@(string.Equals(code, Model.Currency, StringComparison.OrdinalIgnoreCase))">@code</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-apply w-100">
                    <i class="bi bi-graph-up me-2"></i>Показать
                </button>
            </div>
        </form>
    </div>

    <!-- Метрики -->
    <div class="metrics-grid">
        <!-- Среднее время ремонта -->
        <div class="metric-card blue">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <span class="metric-trend down">
                    <i class="bi bi-arrow-down"></i>-12%
                </span>
            </div>
            <div class="metric-value">@Model.AverageRepairDays.ToString("F1")</div>
            <p class="metric-label">Среднее время ремонта</p>
            <p class="metric-subtitle">дней на заказ</p>
        </div>

        <!-- Просрочка SLA -->
        <div class="metric-card red">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                @if (Model.SlaViolationRate > 15)
                {
                    <span class="metric-trend up">
                        <i class="bi bi-arrow-up"></i>+8%
                    </span>
                }
                else
                {
                    <span class="metric-trend down">
                        <i class="bi bi-arrow-down"></i>-3%
                    </span>
                }
            </div>
            <div class="metric-value">@Model.SlaViolationRate.ToString("F1")%</div>
            <p class="metric-label">Просрочка SLA</p>
            <p class="metric-subtitle">от заказов со SLA</p>
        </div>

        <!-- Оценка выручки -->
        <div class="metric-card green">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <span class="metric-trend up">
                    <i class="bi bi-arrow-up"></i>+24%
                </span>
            </div>
            <div class="metric-value">@Model.Revenue.ToString("N0") @Model.Currency</div>
            <p class="metric-label">Фактическая выручка</p>
            <p class="metric-subtitle">Возвраты: @Model.Refunded.ToString("N0") @Model.Currency</p>
        </div>

        <!-- Заказы в периоде -->
        <div class="metric-card orange">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="bi bi-receipt"></i>
                </div>
                <span class="metric-trend up">
                    <i class="bi bi-arrow-up"></i>+15%
                </span>
            </div>
            <div class="metric-value">@Model.TotalOrders</div>
            <p class="metric-label">Заказы в периоде</p>
            <p class="metric-subtitle">всего заказов</p>
        </div>
    </div>

    <!-- Графики -->
    <div class="charts-section">
        <!-- График заказов -->
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Динамика заказов</h3>
                    <p class="chart-subtitle">Количество заказов по дням</p>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="ordersChart"></canvas>
            </div>
        </div>

        <!-- График выручки -->
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Выручка по неделям</h3>
                    <p class="chart-subtitle">План: @Model.PlannedRevenue.ToString("N0") @Model.Currency</p>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Таблица ТОП поломок -->
    <div class="table-card">
        <div class="table-header">
            <h3 class="table-title">
                <i class="bi bi-bar-chart-fill me-2"></i>ТОП поломок
            </h3>
        </div>
        <div class="table-responsive">
            <table class="table defects-table mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px;">#</th>
                        <th>Неисправность</th>
                        <th class="text-end" style="width: 120px;">Количество</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.TopDefects.Any())
                    {
                        <tr>
                            <td colspan="3" class="table-empty">
                                <i class="bi bi-inbox"></i>
                                <div class="text-muted">Записей нет</div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @for (int i = 0; i < Model.TopDefects.Count; i++)
                        {
                            var row = Model.TopDefects[i];
                            <tr>
                                <td class="text-muted fw-semibold">@(i + 1)</td>
                                <td>
                                    <span class="defect-badge">
                                        <i class="bi bi-tools"></i>
                                        @row.Defect
                                    </span>
                                </td>
                                <td class="text-end">
                                    <span class="defect-count">@row.Count</span>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // ==================== ГРАФИКИ ====================
        document.addEventListener('DOMContentLoaded', function() {
            const currencyValue = '@currencyValue';
            const ordersData = @Html.Raw(ordersChartJson);
            const revenueData = @Html.Raw(revenueChartJson);

            const orderLabels = ordersData.map(o => o.date);
            const orderCounts = ordersData.map(o => o.count);

            const revenueLabels = revenueData.map(r => r.week);
            const revenueValues = revenueData.map(r => r.amount);

            // График заказов
            const ordersCtx = document.getElementById('ordersChart');
            if (ordersCtx) {
                new Chart(ordersCtx, {
                    type: 'line',
                    data: {
                        labels: orderLabels.length ? orderLabels : ['Нет данных'],
                        datasets: [{
                            label: 'Заказы',
                            data: orderCounts.length ? orderCounts : [0],
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#2196f3',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: '#1a1a1a',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f0f0f0'
                                },
                                ticks: {
                                    font: { size: 12 }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            }

            // График выручки
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: revenueLabels.length ? revenueLabels : ['Нет данных'],
                        datasets: [{
                            label: `Выручка (${currencyValue})`,
                            data: revenueValues.length ? revenueValues : [0],
                            backgroundColor: '#28a745',
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: '#1a1a1a',
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        return 'Выручка: ' + context.parsed.y.toLocaleString('ru-RU') + ` ${currencyValue}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f0f0f0'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('ru-RU') + ` ${currencyValue}`;
                                    },
                                    font: { size: 12 }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
}